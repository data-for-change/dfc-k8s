x-anyway-command: &x-anyway-command
  ["gunicorn", "-b", "0.0.0.0:5000", "-w", "4", "-t", "120", "anyway:app"]

x-anyway-environment: &x-anyway-environment
  PROXYFIX_X_FOR: "1"
  PROXYFIX_X_PROTO: "1"
  PROXYFIX_X_HOST: "1"
  GOOGLE_APPLICATION_CREDENTIALS: "/secrets/GOOGLE_APPLICATION_CREDENTIALS_KEY.json"

x-anyway: &x-anyway
  image: ${ANYWAY_IMAGE:-ghcr.io/data-for-change/anyway/anyway:latest}
  env_file:
    - ./secrets/anyway.env
    - ./secrets/anyway-db.env
  volumes:
    - ./secrets/GOOGLE_APPLICATION_CREDENTIALS_KEY.json:/secrets/GOOGLE_APPLICATION_CREDENTIALS_KEY.json:ro
  restart: unless-stopped
  networks: [dfc]

services:
  anyway-main:
    <<: *x-anyway
    command: *x-anyway-command
    environment: *x-anyway-environment
    depends_on:
      - db

  anyway-secondary:
    <<: *x-anyway
    entrypoint: *x-anyway-command
    environment:
      <<: *x-anyway-environment
      ALLOW_ALEMBIC_UPGRADE: "no"
    depends_on:
      - anyway-main
    networks: [dfc]

  db:
    hostname: anyway-db
    image: ${PIN_DB_IMAGE:-ghcr.io/hasadna/anyway/db:latest}
    restart: unless-stopped
    environment:
      POSTGRES_USER: postgres
      POSTGRES_DB: postgres
      DBRESTORE_AWS_BUCKET: dfc-anyway-full-db-dumps
      DBRESTORE_FILE_NAME: 2024-01-24_anyway.pgdump
    env_file:
      - ./secrets/db.env
    volumes:
      - /data/anyway/db:/var/lib/postgresql/data
    tmpfs:
      - /dev/shm:size=1024m
    networks: [dfc]
    ports:
      - "9002:5432"

  airflow-db:
    image: postgres:13@sha256:6647385dd9ae11aa2216bf55c54d126b0a85637b3cf4039ef24e3234113588e3
    restart: unless-stopped
    env_file:
      - ./secrets/airflow-db.env
    volumes:
      - /data/anyway/airflow-db:/var/lib/postgresql/data
    networks: [dfc]

  airflow-scheduler:
    image: ${AIRFLOW_IMAGE:-ghcr.io/data-for-change/anyway-etl/anyway-etl-airflow:latest}
    restart: unless-stopped
    environment:
      ANYWAY_ETL_AIRFLOW_ROLE: "scheduler"
      ANYWAY_ETL_AIRFLOW_PIP_INSTALL_DEPS: "yes"
      ANYWAY_ETL_BRANCH: ""
      ANYWAY_ETL_USE_LATEST_TAG: "yes"
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "False"
      AIRFLOW__WEBSERVER__BASE_URL: https://airflow.anyway.co.il
    env_file:
      - ./secrets/airflow-scheduler.env
    volumes:
      - /data/anyway/airflow-home-data:/var/airflow
      - /data/anyway/airflow-etl-data:/var/anyway-etl-data
    networks: [dfc]

  airflow-nginx:
    image: ${ETL_NGINX_IMAGE:-ghcr.io/data-for-change/anyway-etl/anyway-etl-nginx:latest}
    restart: unless-stopped
    volumes:
      - /data/anyway/airflow-etl-data:/var/anyway-etl-data
    networks: [dfc]

  airflow-webserver:
    image: ${AIRFLOW_IMAGE:-ghcr.io/data-for-change/anyway-etl/anyway-etl-airflow:latest}
    restart: unless-stopped
    environment:
      ANYWAY_ETL_AIRFLOW_INITIALIZE: "yes"
      ANYWAY_ETL_AIRFLOW_ROLE: "webserver"
      AIRFLOW__CORE__DAGS_ARE_PAUSED_AT_CREATION: "False"
      AIRFLOW__API__AUTH_BACKENDS: "airflow.api.auth.backend.basic_auth"
    env_file:
      - ./secrets/airflow-webserver.env
    volumes:
      - /data/anyway/airflow-home-data:/var/airflow
    networks: [dfc]

  reports:
    hostname: anyway-reports
    image: ${REPORTS_IMAGE:-ghcr.io/data-for-change/anyway-reports/anyway-reports:latest}
    restart: unless-stopped
    networks: [dfc]

  nginx:
    hostname: anyway-nginx
    image: ${NGINX_IMAGE:-ghcr.io/data-for-change/anyway/nginx:latest}
    restart: unless-stopped
    volumes:
      - ./nginx_anyway_proxy.conf:/etc/nginx/anyway_proxy.conf:ro
    networks: [dfc]

networks:
  dfc:
    external: true
